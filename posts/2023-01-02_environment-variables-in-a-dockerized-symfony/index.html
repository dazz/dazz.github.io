<!doctype html><html lang=en-us><head><meta name=robots content="noai, noimageai"><meta name=viewport content="width=device-width"><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=7"><link rel=icon href=/favicon.png><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=icon href=/logo.svg type=image/svg+xml><title>Environment variables in a dockerized Symfony &ndash;
DazzLog</title><link href=/symbols-nerd-font/symbols-nerd-font.css rel=stylesheet><link href=/jetbrains-mono/jetbrains-mono.css rel=stylesheet><link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><link type=text/css rel=stylesheet href=https://blog.dazzlog.de/css/styles.1f262b17386856e8e4140b026646338b79e747bc3b05c355c2332e4a2a354a11b660e7c932b6078715838dc9e67aab7d8b761bd935d2946f3dcc62129e29ab21.css integrity="sha512-HyYrFzhoVujkFAsCZkYzi3nnR7w7BcNVwjMuSio1ShG2YOfJMrYHhxWDjcnmeqt9i3Yb2TXSlG89zGISnimrIQ=="><link type=text/css rel=stylesheet href=https://blog.dazzlog.de/css/admonition.b96f1a7df9789120ac45fb9c21858b542016295476d737d858978eb00a2922cf562bd9f9e33cf74d71f40248259678c1ba16082bb0ac996b715a938a50b3bec6.css integrity="sha512-uW8affl4kSCsRfucIYWLVCAWKVR21zfYWJeOsAopIs9WK9n54zz3TXH0AkgllnjBuhYIK7CsmWtxWpOKULO+xg=="><link type=text/css rel=stylesheet href=https://blog.dazzlog.de/css/custom.9e1918376e854b03e8b73b155f5d6904182d1db4cdd909cedb995c7e3f2f7d8a2cbe5a9577224365140198b0e84e49e0cd771afd76ad64d3fc54e3bd36acea5d.css integrity="sha512-nhkYN26FSwPotzsVX11pBBgtHbTN2QnO25lcfj8vfYosvlqVdyJDZRQBmLDoTkngzXca/XatZNP8VOO9NqzqXQ=="><script async src="https://www.googletagmanager.com/gtag/js?id=G-SZG9LWH6KX"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SZG9LWH6KX")}</script><meta name=author content="dazz | Anne-Julia Seitz"><meta name=keywords content='cd,ci,docker,docker-compose,dotenv,env_file,symfony'><meta name=description content='a <strong>Symfony Web-Application</strong>, and it runs locally in a dockerized environment with docker-compose. This app is going to be deployed to production as a docker container.
In production the handling of environment variables and how they are passed to the container during development is different.</p>
<h2 id="12-factor-app">12 Factor App</h2>
<p>A few points from the <a href="https://12factor.net">12factor methodology</a>:</p>
<ul>
<li><a href="https://12factor.net/config">III. Config</a>: Store config in the environment since env vars are easy to change between deploys without changing any code</li>
<li><a href="https://12factor.net/dev-prod-parity">X. Dev/prod parity</a>: Keep development, staging, and production as similar as possible</li>
</ul>
<p>I was searching for options how to handle the differences how environment variables are passed and I found there are at least</p>'><meta property="og:site_name" content='DazzLog'><meta property="og:title" content="Environment variables in a dockerized Symfony"><meta property="og:type" content="article"><meta property="article:author" content="dazz | Anne-Julia Seitz"><meta property="article:published_time" content='2023-01-02T19:24:18Z+0100'><meta property="article:tag" content="cd"><meta property="article:tag" content="ci"><meta property="article:tag" content="docker"><meta property="article:tag" content="docker-compose"><meta property="article:tag" content="dotenv"><meta property="article:tag" content="env_file"><meta property="article:tag" content="symfony"><meta property="og:url" content="https://blog.dazzlog.de/posts/2023-01-02_environment-variables-in-a-dockerized-symfony/"><meta property="og:image" content="https://blog.dazzlog.de/posts/2023-01-02_environment-variables-in-a-dockerized-symfony//amy-humphries-2M_sDJ_agvs-unsplash.jpg"><meta property="og:description" content="<p>I have developed a <strong>Symfony Web-Application</strong>, and it runs locally in a dockerized environment with docker-compose. This app is going to be dep"><meta name=twitter:card content="summary_large_image"><meta property="twitter:domain" content='blog.dazzlog.de'><meta property="twitter:url" content="https://blog.dazzlog.de/posts/2023-01-02_environment-variables-in-a-dockerized-symfony/"><meta name=twitter:title content="Environment variables in a dockerized Symfony"><meta name=twitter:image content="https://blog.dazzlog.de/posts/2023-01-02_environment-variables-in-a-dockerized-symfony//amy-humphries-2M_sDJ_agvs-unsplash.jpg"><meta name=twitter:description content="<p>I have developed a <strong>Symfony Web-Application</strong>, and it runs locally in a dockerized environment with docker-compose. This app is going to be dep"><link rel=manifest href=/manifest/index.json></head><body><div id=baseContainer><header><div class=titleAndSearchContainer><div id=titleContainer><a class=unstyledLink href=/><img src=/logo.svg alt=Logo></a><div class=rightOfLogo><div class=titleAndHamburger><h1><a class=unstyledLink href=/>DazzLog</a></h1><label id=hamburger-menu for=main-nav-toggler>&#xf85b;</label></div><div id=wide_nav><nav><input type=checkbox id=main-nav-toggler><ul id=main-nav><li><a href=/>Home</a></li><li><a href=/posts/>Posts</a></li><li><a href=/talks>Talks</a></li><li><a href=/about>About</a></li><li><a href=/tags/>Tags</a></li></ul></nav></div></div></div><div class=search><input id=searchbar type=text placeholder=Search>
<span class=nerdlink onclick=newSearch()>&#xf002;</span></div><script>function newSearch(){let e=searchbar.value.trim();if(!e)return;location.href=`/search/?q=${e}`}searchbar.onkeyup=e=>{e.keyCode==13&&newSearch()}</script></div><div id=links><a rel=noreferrer target=_blank class=nerdlink href=/index.xml>&#xf09e;
<span>RSS
</span></a><a rel=noreferrer target=_blank class=nerdlink href=https://github.com/dazz>&#xf09b;
<span>GitHub
</span></a><a rel=me target=_blank class=nerdlink href=https://phpc.social/@dazz><svg class="pseudofont" width="16" height="16" viewbox="0 0 16 16"><path d="M7.4779094-.1598624e-5C5.5602384.0156984 3.7155894.2233384 2.6405814.7170384c0 0-2.13206093.9537-2.13206093 4.20766.0.74512-.01448 1.63603.0091 2.58084.07742 3.1821946.58336693 6.3183886 3.52553593 7.0971276 1.356568.359063 2.521335.434289 3.45936.382729 1.701085-.09431 2.6560206-.607063 2.6560206-.607063l-.05611-1.234252s-1.2156316.383272-2.5808476.33656c-1.352609-.04639-2.780561-.145832-2.999328-1.80651-.0202-.145872-.03031-.301902-.03031-.465714.0-1e-6 1.327834.324572 3.010574.40167 1.028943.0472 1.993827-.06028 2.9738766-.177218 1.879445-.224425 3.515901-1.382448 3.721577-2.4405646.32407-1.666815.297376-4.067605.297376-4.067605.0-3.25396-2.131943-4.20766-2.131943-4.20766C11.288476.2233384 9.4426784.0156784 7.5250084-.1598624e-5zM5.3076104 2.5424984c.798781.0 1.403595.30701 1.803551.92113l.388886.65181.388884-.65181c.399875-.61412 1.00469-.92113 1.803551-.92113.6903266.0 1.2465526.24267 1.6713186.71609.411755.47342.61677 1.11337.61677 1.91862v3.939988h-1.560986v-3.824218c0-.80613-.339166-1.21531-1.0176126-1.21531-.750129.0-1.126049.48533-1.126049 1.44509v2.09324h-1.551753v-2.09324c0-.95976-.376039-1.44509-1.126168-1.44509-.678446.0-1.017613.40918-1.017613 1.21531v3.824218h-1.560985v-3.939988c0-.80525.205053-1.4452.616889-1.91862.424685-.47342.980911-.71609 1.671317-.71609z"/></svg>
<span>Mastodon</span></a></div></header><div id=contentContainer><div id=content><main><article class="card single"><h1>Environment variables in a dockerized Symfony</h1><p class=date><span title=Date>󰃭 </span>2023-01-02</p><figure style=margin:0><img src=https://blog.dazzlog.de/posts/2023-01-02_environment-variables-in-a-dockerized-symfony//amy-humphries-2M_sDJ_agvs-unsplash.jpg alt></figure><div class=articleToc><nav id=TableOfContents><ul><li><a href=#12-factor-app>12 Factor App</a></li><li><a href=#7-ways-to-pass-environment-variables-to-a-container>7 ways to pass environment variables to a container</a></li></ul><ul><li><a href=#the-goal>The goal</a></li><li><a href=#the-big-picture>The big picture</a></li><li><a href=#steps-towards-the-goal>Steps towards the goal</a></li><li><a href=#the-implementation>The implementation</a><ul><li><a href=#the-directory-tree>The directory tree</a></li></ul></li><li><a href=#the-docker-composeyml>The docker-compose.yml</a></li><li><a href=#disable-dotenv-in-frontcontroller--and-console>Disable DotEnv in frontcontroller and console</a></li><li><a href=#dont-forget-to-add-the-parameters-in-servicesyml>Don’t forget to add the parameters in <code>services.yml</code></a></li><li><a href=#run-docker--container-in-production-with-env-file>Run docker container in production with env-file</a></li><li><a href=#migration-path>Migration Path</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#happy-continuously-deploying-everyone>Happy continuously deploying everyone</a><ul><li><ul><li><a href=#more-sources>More sources</a></li></ul></li></ul></li></ul></nav><hr></div><div><p>I have developed a <strong>Symfony Web-Application</strong>, and it runs locally in a dockerized environment with docker-compose. This app is going to be deployed to production as a docker container.
In production the handling of environment variables and how they are passed to the container during development is different.</p><h2 id=12-factor-app>12 Factor App</h2><p>A few points from the <a href=https://12factor.net>12factor methodology</a>:</p><ul><li><a href=https://12factor.net/config>III. Config</a>: Store config in the environment since env vars are easy to change between deploys without changing any code</li><li><a href=https://12factor.net/dev-prod-parity>X. Dev/prod parity</a>: Keep development, staging, and production as similar as possible</li></ul><p>I was searching for options how to handle the differences how environment variables are passed and I found there are at least</p><h2 id=7-ways-to-pass-environment-variables-to-a-container>7 ways to pass environment variables to a container</h2><ol><li><code>ENV</code> in dockerfile</li><li>Dockerfile args passed at build time to <code>ENV</code></li><li>ENV passing in docker run as option</li><li>Env_file in docker run as option</li><li>Environment variables in <code>docker-compose.yml</code></li><li>Env_file in docker compose for each service</li><li><code>.env</code> in docker compose substitutes variables in <code>docker-compose.yml</code></li></ol><p>And there is even more. If variables are passed to a container there is an order of precedence as follows:</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class=icon>&#xf400;</i> Order of Precedence<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><ol><li>Passed from the command line <a href=https://docs.docker.com/compose/envvars-precedence/../../engine/reference/commandline/compose_run#options><code>docker compose run --env &lt;KEY[=[VAL]]></code></a>.</li><li>Passed from/set in <code>compose.yaml</code> service’s configuration, from the <a href=https://docs.docker.com/compose/envvars-precedence/../../compose/compose-file#environment>environment key</a>.</li><li>Passed from/set in <code>compose.yaml</code> service’s configuration, from the <a href=https://docs.docker.com/compose/envvars-precedence/../../compose/compose-file#env_file>env_file key</a>.</li><li>Passed from/set in Container Image in the <a href=https://docs.docker.com/engine/reference/builder#env>ENV directive</a>.</li></ol><p>from <a href=https://docs.docker.com/compose/envvars-precedence/>https://docs.docker.com/compose/envvars-precedence/</a></p></div></div></div><h1 id=how-to-deal-with-environment-variables-in-a-dockerized-symfony>How to deal with environment variables in a dockerized Symfony</h1><h2 id=the-goal>The goal</h2><p>All services regardless of which technology they use, should have one streamlined way of how the environment variables should be passed to the application.</p><h2 id=the-big-picture>The big picture</h2><ul><li>We use multiple services which all need to work together</li><li>Services run in docker container</li><li>We deploy and run services in different compositions for each environment</li><li>Each service has their own sensitive data</li><li>Each service might be a different technology or has a different tech stack</li></ul><h2 id=steps-towards-the-goal>Steps towards the goal</h2><ul><li>The infrastructure config should be kept in env files but not in the same directory as the application</li><li>Each service gets its own env file to be completely independent of each other, and it gets explicitly set</li><li>During development each service gets the env variables passed via env file (<code>env_file</code> in docker-compose)</li><li>Every project that has a <code>docker-compose.yml</code> moves the application into an <code>app</code> directory to separate the application from its infrastructure configuration</li><li>We remove the DotEnv component from symfony and define each environment variable that we expect as parameter so the app tells us instantly when a key-value pair is missing</li><li>In development credentials can be added to the VCS</li><li>In all other envs the credentials can be either stored and linked on the server or be read from a vault</li></ul><h2 id=the-implementation>The implementation</h2><p>In Symfony the DotEnv component is default installed and enabled in the frontcontroller, so when a new app is created there is always a <code>.env</code> file at the project root created with it. <a href=https://symfony.com/doc/current/configuration.html#configuring-environment-variables-in-env-files>Read more in the documentation.</a></p><p>It is not the same <code>.env</code> that <code>docker-compose.yml</code> expects.<div class="details admonition warning open"><div class="details-summary admonition-title"><i class=icon>&#xf071;</i> Symfony DotEnv and Docker Compose use the same file name .env<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>Docker compose is also using a file named <code>.env</code> to replace the variables in the <code>docker-compose.yml</code> if it is located in the same directory.
If you don&rsquo;t know that and put the web apps <code>.env</code> file in the same place then you accidentally might overwrite variables when you think you just updated a variable for the Symfony application.</div></div></div></p><p>We have two different stacks here that both want to use the <code>.env</code> file and both might, but not at the same time, obviously.</p><p>Since we want to use config variables explicitly and not by accident the Symfony DotEnv component is going to be removed and all config is moved inside environment variable files that are passed into the container.</p><h3 id=the-directory-tree>The directory tree</h3><p>To ease the separation of infrastructure and code the application code moves into the <code>./app</code> directory to be completely separate from the code/config that defines the infrastructure.
You see there is no <code>.env</code> file left from Symfony. All variables have now moved to the env files inside the <code>devops/env</code> directory.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#ff79c6>.</span>
</span></span><span style=display:flex><span>├── app
</span></span><span style=display:flex><span>│   ├── assets
</span></span><span style=display:flex><span>│   ├── bin
</span></span><span style=display:flex><span>│   ├── ci
</span></span><span style=display:flex><span>│   ├── config
</span></span><span style=display:flex><span>│   ├── migrations
</span></span><span style=display:flex><span>│   ├── node_modules
</span></span><span style=display:flex><span>│   ├── public
</span></span><span style=display:flex><span>│   │   └── index<span style=color:#ff79c6>.</span>php
</span></span><span style=display:flex><span>│   ├── src
</span></span><span style=display:flex><span>│   ├── templates
</span></span><span style=display:flex><span>│   ├── tests
</span></span><span style=display:flex><span>│   ├── <span style=color:#ff79c6>var</span>
</span></span><span style=display:flex><span>│   ├── vendor
</span></span><span style=display:flex><span>│   ├── composer<span style=color:#ff79c6>.</span>json
</span></span><span style=display:flex><span>│   ├── composer<span style=color:#ff79c6>.</span>lock
</span></span><span style=display:flex><span>│   ├── Makefile
</span></span><span style=display:flex><span>│   ├── package<span style=color:#ff79c6>.</span>json
</span></span><span style=display:flex><span>│   ├── symfony<span style=color:#ff79c6>.</span>lock
</span></span><span style=display:flex><span>│   ├── webpack<span style=color:#ff79c6>.</span>config<span style=color:#ff79c6>.</span>js
</span></span><span style=display:flex><span>│   └── yarn<span style=color:#ff79c6>.</span>lock
</span></span><span style=display:flex><span>├── devops
</span></span><span style=display:flex><span>│   ├── database
</span></span><span style=display:flex><span>│   ├── docker
</span></span><span style=display:flex><span>│   │   └── frankenphp
</span></span><span style=display:flex><span>│   │        └── Dockerfile
</span></span><span style=display:flex><span>│   └── env
</span></span><span style=display:flex><span>│       ├── app<span style=color:#ff79c6>.</span>env
</span></span><span style=display:flex><span>│       └── database<span style=color:#ff79c6>.</span>env
</span></span><span style=display:flex><span>├── CONTRIBUTING<span style=color:#ff79c6>.</span>md
</span></span><span style=display:flex><span>├── docker<span style=color:#ff79c6>-</span>compose<span style=color:#ff79c6>.</span>prod<span style=color:#ff79c6>.</span>yml
</span></span><span style=display:flex><span>├── docker<span style=color:#ff79c6>-</span>compose<span style=color:#ff79c6>.</span>yml
</span></span><span style=display:flex><span>├── Makefile
</span></span><span style=display:flex><span>└── README<span style=color:#ff79c6>.</span>md
</span></span></code></pre></div><h2 id=the-docker-composeyml>The docker-compose.yml</h2><p>Each service gets its own <code>env_file</code> where we can configure the sensitive data for each service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>version</span>: <span style=color:#f1fa8c>&#39;3.9&#39;</span>  
</span></span><span style=display:flex><span><span style=color:#ff79c6>services</span>:  
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>app</span>:  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>image</span>: ghcr.io/c-base/cbag3:dev-latest  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>build</span>:  
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>dockerfile</span>: ./devops/docker/frankenphp/Dockerfile  
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>target</span>: dev  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>env_file</span>: ./devops/env/app.env  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>ports</span>:  
</span></span><span style=display:flex><span>      - <span style=color:#bd93f9>80</span>:<span style=color:#bd93f9>80</span>  
</span></span><span style=display:flex><span>      - <span style=color:#bd93f9>443</span>:<span style=color:#bd93f9>443</span>  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>volumes</span>:  
</span></span><span style=display:flex><span>      - <span style=color:#f1fa8c>&#39;./app:/app&#39;</span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>database</span>:  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>image</span>: postgres:alpine  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>container_name</span>: database  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>env_file</span>: ./devops/env/database.env  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>ports</span>:  
</span></span><span style=display:flex><span>      - <span style=color:#bd93f9>15432</span>:<span style=color:#bd93f9>5432</span>  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>volumes</span>:  
</span></span><span style=display:flex><span>      - ./devops/database:/var/lib/postgresql
</span></span></code></pre></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class=icon>&#xf400;</i> tip<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>the <code>.env</code> file can be used with docker compose to configure variables inside the <code>docker-compose.yml</code></div></div></div><h2 id=disable-dotenv-in-frontcontroller--and-console>Disable DotEnv in frontcontroller and console</h2><p>The DotEnv component is disabled since all environment variables have already passed to the container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#6272a4># app/public/index.php
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;?</span>php  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#ff79c6>use</span> Cbase\App\Kernel;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>$_SERVER</span>[<span style=color:#f1fa8c>&#39;APP_RUNTIME_OPTIONS&#39;</span>][<span style=color:#f1fa8c>&#39;disable_dotenv&#39;</span>] <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>; 
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#ff79c6>require_once</span> dirname(__DIR__)<span style=color:#ff79c6>.</span><span style=color:#f1fa8c>&#39;/vendor/autoload_runtime.php&#39;</span>;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#ff79c6>return</span> <span style=color:#ff79c6>function</span> (<span style=color:#ff79c6>array</span> <span style=color:#8be9fd;font-style:italic>$context</span>) {  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> Kernel(<span style=color:#8be9fd;font-style:italic>$context</span>[<span style=color:#f1fa8c>&#39;APP_ENV&#39;</span>], (bool) <span style=color:#8be9fd;font-style:italic>$context</span>[<span style=color:#f1fa8c>&#39;APP_DEBUG&#39;</span>]);  
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#6272a4># app/bin/console
</span></span></span><span style=display:flex><span><span style=color:#6272a4>#!/usr/bin/env php  
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;?</span>php  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#ff79c6>use</span> Cbase\App\Kernel;  
</span></span><span style=display:flex><span><span style=color:#ff79c6>use</span> Symfony\Bundle\FrameworkBundle\Console\Application;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>$_SERVER</span>[<span style=color:#f1fa8c>&#39;APP_RUNTIME_OPTIONS&#39;</span>][<span style=color:#f1fa8c>&#39;disable_dotenv&#39;</span>] <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span>;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#ff79c6>require_once</span> dirname(__DIR__) <span style=color:#ff79c6>.</span> <span style=color:#f1fa8c>&#39;/vendor/autoload_runtime.php&#39;</span>;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#ff79c6>return</span> <span style=color:#ff79c6>function</span> (<span style=color:#ff79c6>array</span> <span style=color:#8be9fd;font-style:italic>$context</span>) {  
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>$kernel</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Kernel(<span style=color:#8be9fd;font-style:italic>$context</span>[<span style=color:#f1fa8c>&#39;APP_ENV&#39;</span>], (bool) <span style=color:#8be9fd;font-style:italic>$context</span>[<span style=color:#f1fa8c>&#39;APP_DEBUG&#39;</span>]);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> Application(<span style=color:#8be9fd;font-style:italic>$kernel</span>);  
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class="details admonition symfony open"><div class="details-summary admonition-title"><i class=icon>&#xe756;</i> Symfony Runtime<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>See described here: <a href=https://symfony.com/doc/current/components/runtime.html#using-options>Configure Symfony Runtime Using Options</a></div></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class=icon>&#Xf040;</i> run app only inside container<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>By disabling DotEnv we will no longer be able to run the application outside the container (our local machine) unless we set all environment variables there as well.</div></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class=icon>&#Xf040;</i> keep DotEnv for tests<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>For now, we leave the DotEnv for the tests since those environment variables won&rsquo;t change regardless of where they are executed, and they will be executed in the dev container. We could change that by running the tests in their own container, but for now keep the <code>.env.test</code>.</div></div></div><h2 id=dont-forget-to-add-the-parameters-in-servicesyml>Don&rsquo;t forget to add the parameters in <code>services.yml</code></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#6272a4># app/config/services.yaml</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>parameters</span>:  
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>images.upload.directory</span>: <span style=color:#f1fa8c>&#39;%env(resolve:IMAGES_UPLOAD_DIRECTORY)%&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>services</span>:  
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>_defaults</span>:  
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>autowire</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>autoconfigure</span>: <span style=color:#ff79c6>true</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>bind</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>string $imagesUploadDirectory</span>: <span style=color:#f1fa8c>&#39;%images.upload.directory%&#39;</span>
</span></span></code></pre></div><p>Since every environment has its own env_file there is the danger of forgetting to add an environment variable to the other environments.</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class=icon>&#xf400;</i> tip<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>In order to fail early we load the environment variable at the start of the application, by binding it.
If we do not bind parameters to variables but just bin them to a service we might miss that we forgot to set an
environment variable in the env file since the service might not be loaded in every request.</div></div></div><h2 id=run-docker--container-in-production-with-env-file>Run docker container in production with env-file</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat devops/env/app.env
</span></span><span style=display:flex><span><span style=color:#6272a4># This is a comment</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>IMAGES_UPLOAD_DIRECTORY</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;%kernel.project_dir%/var/uploads&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker run --env-file devops/env/app.env app env | grep -E <span style=color:#f1fa8c>&#39;IMAGES&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>IMAGES_UPLOAD_DIRECTORY</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;%kernel.project_dir%/var/uploads&#34;</span>
</span></span></code></pre></div><p>Read more about it in the <a href=https://docs.docker.com/engine/reference/commandline/run/#-set-environment-variables--e---env---env-file>docker documentation</a>.</p><h2 id=migration-path>Migration Path</h2><p>There is a migration path for projects that use already many config yaml files and want to migrate to environment
variables.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#6272a4># config/my-app.yaml</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>parameters</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>images.upload.directory</span>: <span style=color:#f1fa8c>&#39;%kernel.project_dir%/var/uploads&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#6272a4># config/services.yaml</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>parameters</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>env(IMAGES_UPLOAD_DIRECTORY)</span>: <span style=color:#f1fa8c>&#39;%images.upload.directory%&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>_defaults</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>bind</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>string $imagesUploadDirectory</span>: <span style=color:#f1fa8c>&#39;%env(resolve:IMAGES_UPLOAD_DIRECTORY)%&#39;</span>
</span></span></code></pre></div><ol><li>the configuration processor looks up if there is an environment variable <code>IMAGES_UPLOAD_DIRECTORY</code></li><li>if that is the case, it will be taken,</li><li>otherwise if it is not found <code>'%images.upload.directory%'</code> will be set to the environment variable.</li><li>the <code>'%env(resolve:IMAGES_UPLOAD_DIRECTORY)%'</code> is bound to a variable <code>$imagesUploadDirectory</code></li></ol><p>Read more about configuration processors in the <a href=https://symfony.com/doc/current/configuration/env_var_processors.html>Symfony documentation about &ldquo;Environment Variable Processors&rdquo;</a>.</p><p>This would result in the following migration path:</p><ol><li>Make it possible to set variables via environment variables</li><li>Make sure all environments set the corresponding variables</li><li>Remove many quirky unnecessary config files</li><li>win</li></ol><h2 id=conclusion>Conclusion</h2><p>We removed the DotEnv from Symfony and will miss out on all the functionality that came with it, but chose using the <code>env_file</code> as it can be used for running a container, and it can be configured in the <code>docker-compose.yml</code>.
The environment configs can be dumped from secret vaults regardless of the tech-stack that the cloud has to offer or kept in a shared directory that won&rsquo;t change between deployments.
There will be <strong>one</strong> explicit way of how each service will get configuration regardless of their environment or tech stack.
Also, we learned that there is a simple way in Symfony to migrate to environment variables.</p><h2 id=happy-continuously-deploying-everyone>Happy continuously deploying everyone</h2><h4 id=more-sources>More sources</h4><ul><li><a href=https://rotempinchevskiboguslavsky.medium.com/environment-variables-in-container-vs-docker-compose-file-2426b2ec7d8b>Environment Variables in Container vs. Docker Compose File</a></li></ul></div></article><p class=articleTagsContainer><span> </span><strong>Tags:</strong>
<a href=/tags/cd/>#cd</a>
<a href=/tags/ci/>#ci</a>
<a href=/tags/docker/>#docker</a>
<a href=/tags/docker-compose/>#docker-compose</a>
<a href=/tags/dotenv/>#dotenv</a>
<a href=/tags/env_file/>#env_file</a>
<a href=/tags/symfony/>#symfony</a></p><a style=margin-bottom:24px;display:inline-block class=shareBtn onclick=openFediInstanceDialog()>Share on the Fediverse</a><div id=fediInstanceDialog><div class=bg onclick=closeFediInstanceDialog()></div><div class=dialog><h2>Enter your instance's address</h2><input id=fediInstanceInput placeholder='Eg. mastodon.social' type=text><div class=buttons><a class=shareBtn onclick=closeFediInstanceDialog()>Cancel</a>
<a class=shareBtn onclick=shareOnFedi()>Share</a></div></div></div><script>var articleTitle="Environment variables in a dockerized Symfony",articleLink="https://blog.dazzlog.de/posts/2023-01-02_environment-variables-in-a-dockerized-symfony/",fediInstanceDialog=document.getElementById("fediInstanceDialog"),fediInstanceInput=document.getElementById("fediInstanceInput");function openFediInstanceDialog(){fediInstanceDialog.classList.add("open")}function closeFediInstanceDialog(){fediInstanceDialog.classList.remove("open")}function fixURL(e){return e.substr(0,8)=="https://"?e:e.substr(0,7)=="http://"?e:"https://"+e}function shareOnFedi(){let e=fediInstanceInput.value.trim();if(!e)return;e=fixURL(e),window.open(`${e}/share?text=${articleTitle}%20${articleLink}`,"__blank"),closeFediInstanceDialog()}</script><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script><div id=ficurinia-cactus-comments></div><script>initComments({node:document.getElementById("ficurinia-cactus-comments"),defaultHomeserverUrl:"https://matrix.cactus.chat:8448",serverName:"cactus.chat",siteName:"dazzlog",commentSectionId:"41de65a5694f2611a8483b8f77b95bb5"})</script><div class=relatedArticlesContainer><hr><h2>More posts like this</h2><div class=postlist><article class="card postlistitem"><div><h2><a href=https://blog.dazzlog.de/posts/2025-03-26_running-php-in-a-multi-process-container/>Mastering Multi-Process Containers: Running PHP Applications with s6-overlay</a></h2><p class=date><span title=Date>󰃭 </span>2025-03-26
|
<span title=Tags> </span><a href=/tags/ci>#ci</a>
<a href=/tags/devops>#devops</a>
<a href=/tags/docker>#docker</a>
<a href=/tags/s6-overlay>#s6-overlay</a></p><a class=unstyledLink href=https://blog.dazzlog.de/posts/2025-03-26_running-php-in-a-multi-process-container/><img src=https://blog.dazzlog.de/posts/2025-03-26_running-php-in-a-multi-process-container//multi-process-container.webp alt></a><div class=articlePreview><p><h2 id=the-dockerized-development-setup>The Dockerized Development Setup</h2><p>Containerization has completely changed how we build and deploy PHP applications. With Docker, you can make sure that your production environment behaves just like your local setup, which means fewer surprises when you go live.</p><p>In this post, we&rsquo;re diving into running Symfony in a container that runs multiple processes using s6-overlay. We&rsquo;ll explain why having more than one process in a container can be important, how this idea is different from Docker&rsquo;s usual “one process per container” rule, and how s6-overlay makes it easier to run everything together.</p></p><p><a href=https://blog.dazzlog.de/posts/2025-03-26_running-php-in-a-multi-process-container/>Continue reading </a></p></div></div><hr></article><article class="card postlistitem"><div><h2><a href=https://blog.dazzlog.de/posts/2024-12-06_s6-cli/>Manage s6-overlay setup with s6-cli</a></h2><p class=date><span title=Date>󰃭 </span>2024-12-06
|
<span title=Tags> </span><a href=/tags/ci>#ci</a>
<a href=/tags/devops>#devops</a>
<a href=/tags/docker>#docker</a>
<a href=/tags/s6-overlay>#s6-overlay</a></p><a class=unstyledLink href=https://blog.dazzlog.de/posts/2024-12-06_s6-cli/><img src=https://blog.dazzlog.de/posts/2024-12-06_s6-cli//s6-cli.webp alt></a><div class=articlePreview><p><p>I developed a small cli in golang to ease creating, validating and documenting services that s6 supervises.</p><ul><li>The repo: <a href=https://github.com/dazz/s6-cli>https://github.com/dazz/s6-cli</a></li><li>The docker image: <a href=https://hub.docker.com/repository/docker/hakindazz/s6-cli>https://hub.docker.com/repository/docker/hakindazz/s6-cli</a></li></ul><h2 id=usage>Usage</h2><p>You do not need to install anything, just execute the binary via docker</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -it --rm hakindazz/s6-cli <span style=color:#8be9fd;font-style:italic>help</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>COMMANDS:
</span></span><span style=display:flex><span>   create, c   create a service
</span></span><span style=display:flex><span>   remove, rm  remove a service
</span></span><span style=display:flex><span>   lint, l     lint directories and files
</span></span><span style=display:flex><span>   mermaid, m  document s6 service dependencies in mermaid syntax
</span></span><span style=display:flex><span>   help, h     Shows a list of commands or <span style=color:#8be9fd;font-style:italic>help</span> <span style=color:#ff79c6>for</span> one <span style=color:#8be9fd;font-style:italic>command</span>
</span></span></code></pre></div><h2 id=create-a-service-with-s6-cli>Create a service with s6-cli</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -it --rm -v ./:/etc/s6-overlay hakindazz/s6-cli create oneshot init-dependencies
</span></span></code></pre></div><p>Here is the file / directory structure it creates:</p></p><p><a href=https://blog.dazzlog.de/posts/2024-12-06_s6-cli/>Continue reading </a></p></div></div><hr></article></div></div></main><footer><hr><div class=footerColumns><ul class=notlist><li><strong>this.site</strong></li><li><a target=_blank href=/about>about</a></li><li><a target=_blank href=/impressum>impressum</a></li></ul><ul class=notlist><li><strong>self.dazz</strong></li><li><a target=_blank href=https://github.com/dazz>my GitHub</a></li><li><a target=_blank href=https://medium.com/@dazs>on Medium</a></li><li><a target=_blank href=https://speakerdeck.com/dazz/>Speaker Deck</a></li></ul><ul class=notlist><li><strong>here.links</strong></li><li><a target=_blank href=https://c-base.org>c-base</a></li></ul></div><p><small>2026 &copy; dazz - <a href=https://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License</a>.</small></p><p><small><a href=https://gitlab.com/gabmus/hugo-ficurinia>Ficurinia theme</a> for <a href=https://gohugo.io>Hugo</a> by <a href=https://gabmus.org>Gabriele Musco</a>. Licensed under <a href=https://www.gnu.org/licenses/agpl-3.0.html>GNU AGPLv3</a>.</small></p></footer></div></div></div></body></html>